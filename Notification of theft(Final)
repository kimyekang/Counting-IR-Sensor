#include <SoftwareSerial.h>

int TxPin = 2;
int RxPin = 3;
SoftwareSerial BTSerial(TxPin, RxPin);
int P1 = 0;
int P = 0;
int K;
int B;

int irPin1=4;
int irPin2=5;
int pressPin = A2;
int count=0;
boolean state1 = true;
boolean state2 = true;
boolean insideState = false;
boolean outsideIr=false;
boolean isPeopleExiting=false;
int i=1;
unsigned long Time;

void setup() {
BTSerial.begin(9600);
pinMode(irPin1, INPUT);
pinMode(irPin2, INPUT);
}

void loop() {
  if (BTSerial.available()) {
    Serial.write(BTSerial.read());
  }
  if (Serial.available()){
    BTSerial.write(Serial.read());
  }
  
  int val = analogRead(pressPin); // pressure sensor value
  
  if (!digitalRead(irPin1) && i==1 && state1){
     outsideIr=true;
     delay(500);
     i++;
     state1 = false;
  }

   if (!digitalRead(irPin2) && i==2 &&   state2){
     outsideIr=true;
     delay(500);
     i = 1 ;
     count++;
     Serial.println(count);
     state2 = false;
  }

   if (!digitalRead(irPin2) && i==1 && state2 ){
     outsideIr=true;
     delay(500);
     i = 2 ;
     state2 = false;
  }

  if (!digitalRead(irPin1) && i==2 && state1 ){
     outsideIr=true;
     delay(500);
     count--;
     i = 1;
     state1 = false;
  }  
  
  if ( count <= 0 ) { 
    count = 0;
  }

  
    if (digitalRead(irPin1)){
     state1 = true;
    }

     if (digitalRead(irPin2)){
     state2 = true;
    }
  

  if (count == 0 && val > 10 && P == 0) {
    K = 1;
    BTSerial.println("택배가 도착했습니다.");
    P = 1;
    
  }

  if (count == 1 && val < 10 && K == 1) {
    B = 1;
    Time = millis() / 1000;
  }
  if(count == 0 && val < 10 && B == 1 && P1 == 0) {
    BTSerial.println("도난이 의심됩니다!");
    delay(2000);
    P = 1;
    P1 = 1;
    K = 0;
    B = 0;
    count = 0;
    i = 1;
}

switch(Time) {
  case 20:
      K = 0;
      B = 0;
      count = 0;
      i = 0;
      P = 0;
      P1 = 0;
      BTSerial.println("택배를 수령하였습니다.");
      Serial.println("초기화");
      Time = 0;
      break;
    }
}
